CREATE DATABASE quanlygiaovu1
USE quanlygiaovu1

CREATE TABLE HOCVIEN (
    MAHV CHAR(5) PRIMARY KEY,
    HO CHAR(50),
    TEN CHAR(50),
    NGSINH SMALLDATETIME,
    GIOITINH CHAR(3),
    NOISINH CHAR(50),
    MALOP CHAR(3)  -- Khóa ngoại đến LOP
);

CREATE TABLE KHOA (
    MAKHOA CHAR(50) PRIMARY KEY,
    TENKHOA CHAR(50),
    NGTLAP SMALLDATETIME,
    TRGKHOA CHAR(50)
);

CREATE TABLE MONHOC (
    MAMH CHAR(50) PRIMARY KEY,
    TENMH CHAR(50),
    TCLT TINYINT,
    TCTH TINYINT,
    MAKHOA CHAR(50)  -- Khóa ngoại đến KHOA
);

CREATE TABLE DIEUKIEN (
    MAMH CHAR(50),
    MAMH_TRUOC CHAR(50),
    PRIMARY KEY (MAMH, MAMH_TRUOC)
);

CREATE TABLE GIAOVIEN (
    MAGV CHAR(50) PRIMARY KEY,
    HOTEN CHAR(50),
    HOCVIHOCHAM CHAR(50),
    GIOITINH CHAR(3),
    NGSINH SMALLDATETIME,
    NGVL SMALLDATETIME,
    HESO NUMERIC(4,2),
    MUCLUONG MONEY,
    MAKHOA CHAR(50)  -- Khóa ngoại đến KHOA
);

CREATE TABLE LOP (
    MALOP CHAR(3) PRIMARY KEY,
    TENLOP CHAR(50),
    TRGLOP CHAR(5),
    SISO TINYINT,
    MAGVCN CHAR(50)  -- Khóa ngoại đến GIAOVIEN
);

CREATE TABLE GIANGDAY (
    MALOP CHAR(3),
    MAMH CHAR(50),
    MAGV CHAR(50),
    HOCKY TINYINT,
    NAM SMALLINT,
    TUNGAY SMALLDATETIME,
    DENNGAY SMALLDATETIME,
    PRIMARY KEY (MALOP, MAMH)
);

CREATE TABLE KETQUATHI (
    MAHV CHAR(5),
    MAMH CHAR(50),
    LANTHI TINYINT,
    NGTHI SMALLDATETIME,
    DIEM NUMERIC(4,2),
    KQUA CHAR(50),
    PRIMARY KEY (MAHV, MAMH, LANTHI)
);

-- Thêm các ràng buộc khóa ngoại
ALTER TABLE HOCVIEN ADD CONSTRAINT FK_HV FOREIGN KEY (MALOP) REFERENCES LOP(MALOP);
ALTER TABLE LOP ADD CONSTRAINT FK_LOP FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN(MAGV);
ALTER TABLE KHOA ADD CONSTRAINT FK_KHOA FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV);
ALTER TABLE MONHOC ADD CONSTRAINT FK_MONHOC FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA);
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK_DIEUKIEN FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE GIAOVIEN ADD CONSTRAINT FK_GIAOVIEN FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_GIANGDAY FOREIGN KEY (MALOP) REFERENCES LOP(MALOP);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_GIANGDAY_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_GIANGDAY_MAGV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV);
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_KETQUATHI FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV);
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_KETQUATHI_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE HOCVIEN 
ADD GHICHU VARCHAR(20);
ALTER TABLE HOCVIEN
ADD DIEMTB SMALLINT;
ALTER TABLE HOCVIEN
ADD XEPLOAI VARCHAR(20);
--gioi tinh la nam hoac nu--
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_GIOITINH CHECK (GIOITINH IN ('NAM','NU'));
ALTER TABLE GIAOVIEN
ADD CONSTRAINT kt_gioitinh check (GIOITINH IN ('NAM','NU'));
--Hoc ki co gia tri tu 1 den 3
ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_HOCKI CHECK(HOCKY IN ('1','2','3'));
--HocVi cua giao vien--
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_HOCVI CHECK(HOCVIHOCHAM IN('CN','KS','Ths','TS','PTS'));
--Hoc vien chi duoc thi toi da 3 lan--
alter table KETQUATHI
ADD CONSTRAINT CK_LANTHI CHECK(LANTHI <=3);
-- diem so va lam tron 2 chu so thap phan
alter table KETQUATHI
ADD CONSTRAINT CK_KETQUATHI CHECK(DIEM >= 0 AND DIEM <=10);
--SET KET QUA THI=
UPDATE KETQUATHI
SET KQUA = CASE
WHEN DIEM >= 5 THEN ' DAT'
ELSE 'KHONG DAT'
END;



