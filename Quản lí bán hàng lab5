
CREATE TRIGGER TRG_CHECK_NGHD_NGDK
ON HOADON
AFTER INSERT , UPDATE
AS 
BEGIN
   IF EXISTS ( SELECT 1 FROM inserted as i
   inner join QuanLyBanHang as KH
   ON KH.MAKH = i.MAKH
   WHERE KH.NGDK <= i.NGHD
   )
   BEGIN
   RAISERROR (' Du lieu chan vao bi sai',16,1);
   ROLLBACK;
   END
   END;

   CREATE TRIGGER TRG_CHECK_NGVL_NGHD
   ON HOADON 
   AFTER INSERT , UPDATE
   AS 
   BEGIN
   IF EXISTS( SELECT 1 FROM INSERTED AS i 
   inner join  NHANVIEN AS NV
   ON NV.MANV =  i.MANV
   WHERE i.NGHD >= NV.NGVL )
   BEGIN
   RAISERROR('Du lieu bi sai',16,1);
   ROLLBACK;
   END
   END;
   

   CREATE TRIGGER TRG_UPDATE_TRIGIA
   ON CTHD
   AFTER INSERT , UPDATE 
   AS
   BEGIN
   update HOADON 
   SET TRIGIA = (
   SELECT SUM ( SL * GIA ) FROM CTHD AS CTHD
   INNER JOIN  SANPHAM AS SP
   ON SP.MASP = CTHD.MASP
   WHERE CTHD.SOHD = HOADON.SOHD
   )
   where HOADON.SOHD IN (
   SELECT DISTINCT SOHD FROM inserted
   union
   select distinct SOHD FROM deleted
   );
   end;
CREATE TRIGGER TRG_DOANHSO
ON QUANLYBANHANG 
AFTER INSERT , UPDATE
AS 
BEGIN
UPDATE QuanLyBanHang
SET DOANHSO = 
( SELECT SUM(TRIGIA) FROM HOADON AS HD
WHERE QuanLyBanHang.MAKH = HD.MAKH
GROUp BY MAKH
)
WHERE QuanLyBanHang.MAKH IN(
SELECT MAKH FROM inserted
UNION
SELECT MAKH FROM deleted
);
END;
